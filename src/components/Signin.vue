<template>
  <div class="signin-panel">
    <div class="login-content">
      <div class="login-header">登录鸟</div>
      <Form :layout="formLayout" :form="form">
        <p class="errormsg">{{errorTip}}</p>
        <FormItem label="用户名" :label-col="{span:4}" :wrapper-col="{span:20}" :required="false">
          <Input
            style="height:40px"
            @focus="inputFocus"
            :class="{'haserror':errorTip.length>0}"
            v-decorator="[
              'username',
              {
              rules: [{ required: true, message: '请输入用户名'},{whitespace:true ,message:'请输入用户名'}]
              }
            ]
            "
            placeholder="请输入用户名"
          />
        </FormItem>
        <FormItem label="密码" :label-col="{span:4}" :wrapper-col="{span:20}" :required="false">
          <Input
            type="password"
            style="height:40px"
            :class="{'haserror':errorTip.length>0}"
            @focus="inputFocus"
            v-decorator="[
              'password',
              {
                rules: [{ required: true, message: '请输入密码' },{whitespace:true ,message:'请输入密码'}]
              }
            ]"
            placeholder="请输入密码"
          />
        </FormItem>
        <FormItem label="验证码" :label-col="{span:4}" :wrapper-col="{span:20}" :required="false">
          <div class="identifycode-div">
            <Input
              class="identityinput"
              style="height:40px"
              v-decorator="[
                'identifycode',
                {
                  rules: [
                    {
                      required: true,
                      message: '请输入验证码'
                    },
                    {
                      whitespace: true,
                      message: '请输入验证码'
                    }
                  ]
                }
              ]"
              placeholder="请输入验证码"
            />
            <IdentifyCode @codeChange="getIdenCode" ref="idenCode"></IdentifyCode>
          </div>
        </FormItem>
        <FormItem class="loginbtn" :label-col="{span:4}" :wrapper-col="{span:20}">
          <Button :loading="loading" type="primary" @click="handleSubmit">登录</Button>
        </FormItem>
      </Form>
    </div>
  </div>
</template>

<script lang="ts">
import { Vue, Component, Watch } from "vue-property-decorator";
import { Form, Button, Input, message } from "ant-design-vue";
import IdentifyCode from "./IdentifyCode.vue";

@Component({
  name: "Signin",
  components: {
    Form,
    Button,
    Input,
    FormItem: Form.Item,
    IdentifyCode
  }
})
export default class Signin extends Vue {
  public $refs!: {
    idenCode: IdentifyCode;
  };
  // 错误提示
  private errorTip: string = "";
  private form: any;
  // 表单布局
  private formLayout: string = "horizontal";
  // 生成的验证码
  private nativeIdentityCode: string = "";
  // 加载开关
  private loading: boolean = false;
  /**
   * 初始化
   */
  private created() {
    this.form = this.$form.createForm(this);
    this.$nextTick(() => {
      window.addEventListener("keypress", e => {
        if (e.keyCode === 13) {
          this.handleSubmit();
        }
      });
    });
  }
  // 获取生成的验证码
  private getIdenCode(code: string) {
    this.nativeIdentityCode = code;
  }
  // 检验验证码
  private checkIdentityCode(code: string): boolean {
    if (code && code.toUpperCase() !== this.nativeIdentityCode.toUpperCase()) {
      this.form.setFields({
        identifycode: { errors: [new Error("验证码输入错误")] }
      });
      this.$refs.idenCode.drawPic();
      return false;
    }
    return true;
  }
  // 输入框聚焦
  inputFocus() {
    this.errorTip = "";
  }
  /**
   *  登录表单提交
   */
  private handleSubmit() {
    this.form.validateFields((err: any, values: any) => {
      if (!err && this.checkIdentityCode(values.identifycode)) {
        if(values.username==="zpwan" && values.password === "zpwan123"){
            this.loading = true;
            this.$router.push("/app")
        }else{
            this.form.setFields({
                username:{value:"",errors:[new Error('用户名或密码错误')]},
                password:{value:"",errors:[new Error('用户名或密码错误')]}
            })
        }
      }
    });
  }
}
</script>
<style lang="less" scoped>
.signin-panel {
  position: relative;
  height: 100%;
  background-color: #f0f2f5;
  .login-content {
    position: fixed;
    width: 480px;
    height: 390px;
    right: 50%;
    top: 55%;
    transform: translate3d(50%, -65%, 0);
    background-color: #fff;
    border-radius: 5px;
    box-shadow: "0, 0, 5px #eee";
    padding: 35px 59px 95px 59px;
    .errormsg {
      color: red;
      margin: 3px 0 6px 60px;
      text-align: left;
    }
    .haserror {
      border: 1px solid red;
    }
    .login-header {
      text-align: center;
      font-size: 24px;
      margin-bottom: 24px;
    }
    .identifycode-div {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      .identityinput {
        width: 180px;
      }
    }
    .loginbtn {
      margin-top: 20px;
      display: flex;
      flex-direction: row;
      justify-content: center;
      button {
        width: 100%;
      }
    }
  }
}
</style>
